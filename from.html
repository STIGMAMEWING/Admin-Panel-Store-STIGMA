<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulir Pembelian</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 to-black text-white min-h-screen flex items-center justify-center p-4">

  <div class="bg-gray-800/80 p-6 rounded-xl shadow-lg w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">üí≥ Formulir Pembelian</h2>
    <p id="produkTerpilih" class="text-center text-yellow-400 mb-4"></p>
    
    <p class="text-center text-red-400 font-semibold mb-4">Silahkan ditransfer terlebih dahulu</p>

    <form id="paymentForm" class="space-y-3" autocomplete="off">
      <input type="text" id="name" placeholder="Nama Anda"
        class="w-full px-3 py-2 rounded-lg bg-gray-700 focus:outline-none" required>

      <input type="email" id="email" placeholder="Email Anda"
        class="w-full px-3 py-2 rounded-lg bg-gray-700 focus:outline-none" required>

      <label class="block text-sm text-gray-300">Pilih Bank / E-Wallet / QRIS:</label>
      <select id="bank" class="w-full px-3 py-2 rounded-lg bg-gray-700 focus:outline-none" required>
        <option value="DANA" data-rek="082123302182" data-nama="Aldi Juli Saputra">DANA - 082123302182 / Aldi Juli Saputra</option>
        <option value="Seabank" data-rek="901881696550" data-nama="Aldi Juli Saputra">Seabank - 901881696550 / Aldi Juli Saputra</option>
        <option value="BCA" data-rek="4142233766" data-nama="Aldi Juli Saputra">BCA - 4142233766 / Aldi Juli Saputra</option>
        <option value="QRIS">QRIS</option>
      </select>

      <div id="infoDiv" class="my-2 hidden text-center"></div>

      <!-- Jumlah: editable tanpa tombol format/copy -->
      <div>
        <input type="number" id="jumlah" placeholder="Jumlah Deposit (IDR)" step="1000" min="0"
          class="w-full px-3 py-2 rounded-lg bg-gray-700 focus:outline-none" required>
      </div>
      <p id="jumlahDisplay" class="text-sm text-gray-300 text-right mt-1"></p>

      <textarea id="keterangan" placeholder="Keterangan (opsional)"
        class="w-full px-3 py-2 rounded-lg bg-gray-700 focus:outline-none"></textarea>

      <label class="block text-sm text-gray-300">Upload Bukti Pembayaran:</label>
      <input type="file" id="bukti" accept="image/*"
        class="w-full px-3 py-2 rounded-lg bg-gray-700 focus:outline-none" required>

      <button type="submit"
        class="w-full bg-yellow-500 hover:bg-yellow-600 text-black py-2 rounded-lg font-semibold">Kirim</button>
    </form>

    <div id="result" class="hidden mt-4 text-center">
      <h3 class="text-lg font-semibold mb-2 text-green-400">‚úÖ Data berhasil dikirim!</h3>
      <p class="mb-2 text-sm text-gray-300">Silakan hubungi admin melalui sosial media untuk konfirmasi:</p>
      <div class="flex gap-3 justify-center">
        <a href="https://wa.me/6285210441979" target="_blank"
           class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg">WhatsApp</a>
        <a href="https://discord.gg/DMKxAh8x3j" target="_blank"
           class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg">Discord</a>
        <a href="https://www.instagram.com/aldi_5301?igsh=NXhkeWp5bXRtM2Fy" target="_blank"
           class="bg-pink-600 hover:bg-pink-700 px-4 py-2 rounded-lg">Instagram</a>
        <a href="https://www.facebook.com/share/1GogBFFcut/" target="_blank"
           class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">Facebook</a>
      </div>
    </div>
  </div>

  <script>
    /* Helper: format ke Rupiah (IDR) tanpa desimal */
    function formatRupiah(number) {
      if (number === "" || number === null || Number.isNaN(Number(number))) return "";
      const n = Number(number);
      return n.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 });
    }

    const bankSelect = document.getElementById("bank");
    const infoDiv = document.getElementById("infoDiv");
    const urlParams = new URLSearchParams(window.location.search);
    const namaProduk = urlParams.get('produk');
    const hargaProduk = urlParams.get('harga');

    const jumlahInput = document.getElementById("jumlah");
    const jumlahDisplay = document.getElementById("jumlahDisplay");

    if (hargaProduk) {
      const clean = String(hargaProduk).replace(/[^0-9]/g, '');
      if (clean) jumlahInput.value = clean;
      jumlahDisplay.innerText = clean ? formatRupiah(clean) : "";
    }

    if (namaProduk) {
      document.getElementById("produkTerpilih").innerText = `Anda akan membeli: ${namaProduk}`;
    }

    // Render info rekening / QRIS
    function renderPaymentInfo() {
      const selected = bankSelect.options[bankSelect.selectedIndex];
      if (!selected) return;
      if (bankSelect.value === "QRIS") {
        const qrisUrl = "https://i.ibb.co/B5V0W1dL/QrisAldi.jpg";
        infoDiv.innerHTML = `
          <img src="${qrisUrl}" alt="QRIS" class="mx-auto mb-2 rounded-lg shadow-lg" style="max-width:220px;">
          <a href="${qrisUrl}" download
             class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg text-white inline-block">‚¨áÔ∏è Download QRIS</a>
        `;
        infoDiv.classList.remove("hidden");
      } else {
        const rek = selected.getAttribute("data-rek") || "-";
        const nama = selected.getAttribute("data-nama") || "-";
        infoDiv.innerHTML = `
          <p class="mb-2 text-yellow-300">No Rekening: <span id="rekText">${rek}</span><br>Atas Nama: ${nama}</p>
          <button type="button" id="copyRekBtn" 
            class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg text-white">üìã Copy Rekening</button>
        `;
        infoDiv.classList.remove("hidden");

        setTimeout(() => {
          const copyRekBtn = document.getElementById("copyRekBtn");
          if (copyRekBtn) {
            copyRekBtn.addEventListener('click', () => {
              navigator.clipboard.writeText(rek).then(() => {
                alert("Nomor rekening berhasil dicopy: " + rek);
              }).catch(err => console.error("Gagal copy:", err));
            });
          }
        }, 0);
      }
    }

    bankSelect.addEventListener("change", renderPaymentInfo);
    renderPaymentInfo();

    jumlahInput.addEventListener("input", () => {
      const raw = jumlahInput.value ? String(jumlahInput.value).replace(/[^0-9]/g, '') : "";
      jumlahDisplay.innerText = raw ? formatRupiah(raw) : "";
    });

    document.getElementById("paymentForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const bukti = document.getElementById("bukti").files[0];
      if (!bukti) {
        alert("Harap upload bukti pembayaran!");
        return;
      }

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const bank = document.getElementById("bank").value;
      const jumlahRaw = jumlahInput.value ? String(jumlahInput.value).replace(/[^0-9]/g, '') : "";
      if (!jumlahRaw) {
        alert("Harap masukkan jumlah deposit.");
        return;
      }
      const jumlah = jumlahRaw;
      const keterangan = document.getElementById("keterangan").value.trim() || "-";

      const webhookURL = "https://discord.com/api/webhooks/1416650188763959336/LzgKpEeYPI9F4szWAxgaVQlnQcvQCMQLigbkeIn4NpRdUXP_w2ePMCWYKth-3ZpjB99o";

      const formData = new FormData();
      formData.append("file", bukti);

      const embedPayload = {
        embeds: [{
          title: `üõçÔ∏è Transaksi Baru: ${namaProduk || 'Produk'}`,
          description: "Ada pesanan baru yang masuk!",
          color: 3447003,
          fields: [
            { name: "Nama Pembeli", value: name || "-", inline: true },
            { name: "Email", value: email || "-", inline: true },
            { name: "Produk", value: namaProduk || "-", inline: false },
            { name: "Jumlah Pembayaran", value: `Rp ${Number(jumlah).toLocaleString('id-ID')}`, inline: true },
            { name: "Metode Pembayaran", value: bank, inline: true },
            { name: "Keterangan", value: keterangan, inline: false }
          ]
        }]
      };

      formData.append("payload_json", JSON.stringify(embedPayload));

      fetch(webhookURL, {
        method: "POST",
        body: formData,
      })
      .then(response => {
        if (!response.ok) throw new Error("Gagal mengirim notifikasi ke Discord.");
      })
      .catch(error => {
        console.error("Kesalahan:", error);
        alert("Terjadi kesalahan saat mengirim notifikasi (cek console).");
      });

      let transactions = JSON.parse(localStorage.getItem("transactions")) || [];
      transactions.push({
        nama: name || "-",
        email: email || "-",
        produk: namaProduk || "-",
        harga: jumlah,
        bank: bank,
        keterangan: keterangan,
        tanggal: new Date().toLocaleString()
      });
      localStorage.setItem("transactions", JSON.stringify(transactions));
      localStorage.setItem("produkDibeli", namaProduk || "-");

      document.getElementById("paymentForm").classList.add("hidden");
      document.getElementById("result").classList.remove("hidden");
    });
  </script>

</body>
</html>
